# Lab 11

## Prepare
Start Minikube
```sh
$ minikube start --vm-driver=docker
```

## Create secrets with kubectl
```sh
$ kubectl create secret generic lab11 --from-literal=NAME=DANIIL

secret/lab11 created
```

```sh
$ kubectl get secret lab11 -o jsonpath="{.data.NAME}" | base64 -d

DANIIL
```

## Helm
```sh
$ helm install app-python-pass ./app-python/ --set password="lab11"
W1113 13:48:19.106212   30452 warnings.go:70] unknown field "metadata.automountServiceAccountToken"
NAME: app-python-pass
LAST DEPLOYED: Mon Nov 13 13:47:55 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
NOTES:
1. Get the application URL by running these commands:
  http://python.app/
```

```sh
$ kubectl get po
NAME                               READY   STATUS      RESTARTS   AGE
app-python-pass-849df9b76c-zvpl7   1/1     Running     0          3m1s
postinstall-hook                   0/1     Completed   0          3m1s
preinstall-hook                    0/1     Completed   0          3m24s
```

```sh
$ kubectl exec app-python-pass-849df9b76c-zvpl7 -- printenv | grep MY_PASS
MY_PASS=lab11
```

## Vault

### Set a Secret in Vault

```sh
kubectl exec -it vault-0 -- /bin/sh
/ $ vault secrets enable -path=internal kv-v2
Success! Enabled the kv-v2 secrets engine at: internal/
/ $ vault kv put internal/database/config username="db-readonly-username" password="db-secret-password"
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T15:07:28.345918243Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1
/ $ vault kv get internal/database/config
======== Secret Path ========
internal/data/database/config

======= Metadata =======
Key                Value
---                -----
created_time       2023-11-14T15:07:28.345918243Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

====== Data ======
Key         Value
---         -----
password    db-secret-password
username    db-readonly-username
/ $ exit
```

### Configure Kubernetes Authentication

```sh
kubectl exec -it vault-0 -- /bin/sh
/ $ vault auth enable kubernetes
Success! Enabled kubernetes auth method at: kubernetes/
/ $ vault write auth/kubernetes/config \
>       kubernetes_host="https://$KUBERNETES_PORT_443_TCP_ADDR:443"
Success! Data written to: auth/kubernetes/config
/ $ vault policy write internal-app - <<EOF
> path "internal/data/database/config" {
>    capabilities = ["read"]
> }
> EOF
Success! Uploaded policy: internal-app
/ $ vault write auth/kubernetes/role/internal-app \
>       bound_service_account_names=internal-app \
>       bound_service_account_namespaces=default \
>       policies=internal-app \
>       ttl=24h
Success! Data written to: auth/kubernetes/role/internal-app
/ $ exit
```

### Define a Kubernetes service account
```sh
$ kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-python-pass        0         24h
default                0         12d
vault                  0         20h
vault-agent-injector   0         20h
```

```sh
$ kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-python-pass        0         24h
default                0         12d
vault                  0         20h
vault-agent-injector   0         20h
```

```sh
$ kubectl get serviceaccounts
NAME                   SECRETS   AGE
app-python-pass        0         24h
default                0         12d
internal-app           0         5s
vault                  0         20h
vault-agent-injector   0         20h
```

Edits in values.yaml
```sh
serviceAccount:
  # Specifies whether a service account should be created
  create: false
  # Automatically mount a ServiceAccount's API credentials?
  automount: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: "internal-app"
```